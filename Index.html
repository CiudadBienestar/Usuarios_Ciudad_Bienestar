// Función principal con mejor manejo de errores
async function enviarDatos(event) {
    event.preventDefault();
    const form = event.target;
    const correo = form.correo.value.toLowerCase().trim();
    const submitButton = form.querySelector('button[type="submit"]');

    console.log('Iniciando proceso para correo:', correo);

    if (!validarCorreo(correo)) {
        mostrarError('Por favor, ingrese un correo electrónico válido.');
        return;
    }

    try {
        deshabilitarFormulario(true, submitButton);
        mostrarCargando(true);

        console.log('Buscando usuario en la base de datos...');
        const usuarioData = await buscarUsuario(correo);
        
        if (!usuarioData) {
            console.log('Usuario no encontrado para el correo:', correo);
            mostrarError('Correo no encontrado en nuestra base de datos');
            return;
        }

        console.log('Usuario encontrado, preparando envío de correo...');
        console.log('Datos del usuario:', {
            correo: usuarioData.Correo,
            nombre: usuarioData.Nombre,
            curso: usuarioData.Curso
        });

        await enviarCorreo(usuarioData);
        console.log('Correo enviado exitosamente');
        
        mostrarExito('Credenciales enviadas con éxito a tu correo electrónico');
        form.reset();

    } catch (error) {
        console.error('Error detallado:', error);
        let mensajeError = 'Ocurrió un error al procesar tu solicitud.';
        
        if (error.message.includes('base de datos')) {
            mensajeError = 'Error al consultar la base de datos. Por favor, intenta más tarde.';
        } else if (error.message.includes('correo')) {
            mensajeError = 'Error al enviar el correo. Por favor, verifica tu dirección de correo.';
        }
        
        mostrarError(mensajeError);
    } finally {
        mostrarCargando(false);
        deshabilitarFormulario(false, submitButton);
    }
}

// Función mejorada para buscar usuario
async function buscarUsuario(correo) {
    const url = 'https://sheetdb.io/api/v1/ah7z1m18520d5';
    
    try {
        console.log('Iniciando búsqueda en:', url);
        
        const response = await fetch(url);
        console.log('Estado de la respuesta:', response.status);
        
        if (!response.ok) {
            throw new Error(`Error en la respuesta del servidor: ${response.status}`);
        }

        const data = await response.json();
        console.log('Datos recibidos:', data ? 'Datos válidos' : 'Sin datos');

        if (!Array.isArray(data)) {
            console.error('Formato de datos inválido:', typeof data);
            throw new Error('Formato de datos inválido');
        }

        const usuario = data.find(entry => 
            entry && entry.Correo && 
            entry.Correo.toLowerCase() === correo.toLowerCase()
        );

        console.log('Usuario encontrado:', usuario ? 'Sí' : 'No');
        return usuario;

    } catch (error) {
        console.error('Error completo en buscarUsuario:', error);
        throw new Error('Error al consultar la base de datos: ' + error.message);
    }
}

// Función mejorada para enviar correo
async function enviarCorreo(usuarioData) {
    console.log('Iniciando envío de correo...');
    
    const templateParams = {
        to_email: usuarioData.Correo,
        to_name: usuarioData.Nombre || 'Usuario',
        to_usuario: usuarioData.Usuario || 'No disponible',
        to_password: usuarioData.Password || 'No disponible',
        to_curso: usuarioData.Curso || 'No disponible',
    };

    try {
        console.log('Enviando correo con EmailJS...');
        
        const resultado = await emailjs.send(
            'service_s8nq09o', 
            'users_kfihheo', 
            templateParams
        );

        console.log('Respuesta de EmailJS:', resultado);
        
        if (!resultado || resultado.status !== 200) {
            throw new Error(`Error en el envío: Estado ${resultado?.status}`);
        }

        return resultado;

    } catch (error) {
        console.error('Error detallado en enviarCorreo:', error);
        throw new Error('Error al enviar el correo electrónico: ' + error.message);
    }
}

// Función para mostrar mensajes de error más detallados
function mostrarError(mensaje) {
    console.error('Error mostrado al usuario:', mensaje);
    const mensajeElement = document.getElementById('mensaje');
    mensajeElement.textContent = mensaje;
    mensajeElement.className = 'mensaje error';
    mensajeElement.style.display = 'block';

    setTimeout(() => {
        mensajeElement.style.display = 'none';
    }, 5000);
}
