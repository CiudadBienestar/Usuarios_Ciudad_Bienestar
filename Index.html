// Configuración
const CONFIG = {
    LIMITE_INTENTOS: 3,
    TIEMPO_ESPERA: 300000, // 5 minutos
    EMAIL_PUBLIC_KEY: "vrWv7cbILG9o5ZEALbC82", // Idealmente en variables de entorno
    SHEETDB_URL: "https://sheetdb.io/api/v1/ah7z1m18520d5"
};

// Clase para manejar el control de ratio límite
class RateLimiter {
    constructor() {
        this.intentos = new Map();
        this.timeouts = new Map();
    }

    verificarLimite(correo) {
        const intentos = this.intentos.get(correo) || [];
        const ahora = Date.now();
        const intentosRecientes = intentos.filter(tiempo => 
            ahora - tiempo < CONFIG.TIEMPO_ESPERA
        );
        
        this.intentos.set(correo, intentosRecientes);
        return intentosRecientes.length < CONFIG.LIMITE_INTENTOS;
    }

    registrarIntento(correo) {
        const intentos = this.intentos.get(correo) || [];
        intentos.push(Date.now());
        this.intentos.set(correo, intentos);

        // Limpiar timeout anterior si existe
        if (this.timeouts.has(correo)) {
            clearTimeout(this.timeouts.get(correo));
        }

        // Establecer nuevo timeout
        const timeoutId = setTimeout(() => {
            this.intentos.delete(correo);
            this.timeouts.delete(correo);
        }, CONFIG.TIEMPO_ESPERA);

        this.timeouts.set(correo, timeoutId);
    }

    limpiar(correo) {
        this.intentos.delete(correo);
        if (this.timeouts.has(correo)) {
            clearTimeout(this.timeouts.get(correo));
            this.timeouts.delete(correo);
        }
    }
}

// Instancia global del rate limiter
const rateLimiter = new RateLimiter();

// Función mejorada para buscar usuario
async function buscarUsuario(correo) {
    try {
        const response = await fetch(CONFIG.SHEETDB_URL);
        if (!response.ok) {
            throw new Error(`Error en la respuesta: ${response.status}`);
        }
        const data = await response.json();
        
        // Validar estructura de datos
        if (!Array.isArray(data)) {
            throw new Error('Formato de datos inválido');
        }

        const usuario = data.find(entry => 
            entry && 
            typeof entry.Correo === 'string' && 
            entry.Correo.toLowerCase() === correo.toLowerCase()
        );

        return usuario || null;
    } catch (error) {
        console.error('Error al buscar usuario:', error);
        throw new Error('Error al consultar la base de datos');
    }
}

// Función principal mejorada
async function enviarDatos(event) {
    event.preventDefault();
    const form = event.target;
    const correo = form.correo.value.toLowerCase().trim();
    const submitButton = form.querySelector('button[type="submit"]');

    if (!validarCorreo(correo)) {
        mostrarError('Por favor, ingrese un correo electrónico válido.');
        return;
    }

    if (!rateLimiter.verificarLimite(correo)) {
        mostrarError(`Has excedido el límite de intentos. Por favor, espera 5 minutos.`);
        return;
    }

    try {
        deshabilitarFormulario(true, submitButton);
        mostrarCargando(true);

        const usuarioData = await buscarUsuario(correo);
        if (usuarioData) {
            await enviarCorreo(usuarioData);
            mostrarExito('Credenciales enviadas con éxito a tu correo electrónico');
            form.reset();
            rateLimiter.limpiar(correo); // Limpiar intentos tras éxito
        } else {
            mostrarError('Correo no encontrado en nuestra base de datos');
            rateLimiter.registrarIntento(correo);
        }
    } catch (error) {
        console.error('Error en el proceso:', error);
        mostrarError('Ocurrió un error al procesar tu solicitud. Por favor, intenta nuevamente más tarde.');
        rateLimiter.registrarIntento(correo);
    } finally {
        mostrarCargando(false);
        deshabilitarFormulario(false, submitButton);
    }
}

// Función mejorada para enviar correo
async function enviarCorreo(usuarioData) {
    const templateParams = {
        to_email: usuarioData.Correo,
        to_name: usuarioData.Nombre || 'Usuario',
        to_usuario: usuarioData.Usuario || 'No disponible',
        to_password: usuarioData.Password || 'No disponible',
        to_curso: usuarioData.Curso || 'No disponible',
    };

    try {
        const resultado = await emailjs.send('service_s8nq09o', 'users_kfihheo', templateParams);
        if (!resultado || resultado.status !== 200) {
            throw new Error('Error en el envío del correo');
        }
    } catch (error) {
        console.error('Error al enviar correo:', error);
        throw new Error('Error al enviar el correo electrónico');
    }
}
